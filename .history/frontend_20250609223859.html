<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>One-to-One Chat</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 8px; margin: 5px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 10px; }
    .typing { font-style: italic; color: gray; margin-top: 5px; }
    .seen-status { font-size: 12px; color: green; text-align: right; }
    .feature-section { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .feature-section h4 { margin-top: 0; color: #333; }
    .reaction-btn { padding: 5px; margin: 2px; border: none; background: #f0f0f0; border-radius: 3px; cursor: pointer; }
    .reaction-btn:hover { background: #e0e0e0; }
  </style>
</head>
<body>
  <h2>üü¢ One-to-One Chat App</h2>

  <div class="feature-section">
    <h4>Connection</h4>
    <label>JWT Token:</label><br />
    <input type="text" id="jwt" size="80" placeholder="Enter your JWT token" />
    <button onclick="connectSocket()">Connect</button>
    <div id="connectionStatus"></div>
  </div>

  <div class="feature-section">
    <h4>Send Message</h4>
    <label>Recipient User ID:</label><br />
    <input type="text" id="recipientId" size="50" placeholder="Enter recipient user ID" /><br />

    <label>Message:</label><br />
    <input type="text" id="messageInput" size="50" placeholder="Enter your message" oninput="sendTyping()" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <!-- File Upload Section -->
  <div class="feature-section">
    <h4>File Upload</h4>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="uploadImage()">Upload Image</button>
    <br><br>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload File</button>
  </div>

  <!-- Message Actions -->
  <div class="feature-section">
    <h4>Message Actions</h4>
    <input type="text" id="messageIdInput" placeholder="Message ID" />
    <input type="text" id="editMessageInput" placeholder="New message content" />
    <button onclick="editMessage()">Edit Message</button>
    <button onclick="deleteMessage('me')">Delete for Me</button>
    <button onclick="deleteMessage('everyone')">Delete for Everyone</button>
    <div style="margin-top: 10px;">
      <label>Add Reaction:</label>
      <button class="reaction-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
      <button class="reaction-btn" onclick="addReaction('üëç')">üëç</button>
      <button class="reaction-btn" onclick="addReaction('üòÇ')">üòÇ</button>
      <button class="reaction-btn" onclick="addReaction('üò¢')">üò¢</button>
      <button class="reaction-btn" onclick="addReaction('üòÆ')">üòÆ</button>
    </div>
  </div>

  <!-- Search Messages -->
  <div class="feature-section">
    <h4>Search Messages</h4>
    <input type="text" id="searchInput" placeholder="Search messages..." />
    <button onclick="searchMessages()">Search</button>
  </div>

  <div id="chatBox"></div>
  <div class="typing" id="typingStatus"></div>

  <script>
    let socket;

    function connectSocket() {
      const token = document.getElementById('jwt').value;
      if (!token) {
        alert("Please enter a JWT token");
        return;
      }

      socket = io('http://localhost:5000', {
        auth: { token },
      });

      socket.on('connect', () => {
        document.getElementById('connectionStatus').innerHTML = '‚úÖ Connected to server';
        console.log('Connected to socket server');
      });

      socket.on('connect_error', (err) => {
        document.getElementById('connectionStatus').innerHTML = '‚ùå Connection failed: ' + err.message;
        console.error('Connection error:', err.message);
      });

      socket.on('private-message', (data) => {
        const chatBox = document.getElementById('chatBox');
        let messageContent = '';
        
        if (data.messageType === 'image') {
          messageContent = `<img src="${data.image.url}" alt="Image" style="max-width: 200px; max-height: 200px;" />`;
        } else if (data.messageType === 'file') {
          messageContent = `<a href="${data.file.url}" download="${data.file.originalName}">${data.file.originalName}</a>`;
        } else {
          messageContent = data.message;
        }
        
        const message = `
          <div><b>${data.from}:</b> ${messageContent}</div>
          <div class="seen-status">Seen</div>
        `;
        chatBox.innerHTML += message;
        chatBox.scrollTop = chatBox.scrollHeight;

        // Send "seen" event to server
        socket.emit('message-seen', { messageId: data.messageId });
      });

      socket.on('user-typing', ({ from }) => {
        const typingStatus = document.getElementById('typingStatus');
        typingStatus.innerText = `‚úçÔ∏è ${from} is typing...`;
        clearTimeout(typingStatus.timeout);
        typingStatus.timeout = setTimeout(() => {
          typingStatus.innerText = '';
        }, 1000);
      });

      socket.on('message-seen-confirmation', ({ messageId }) => {
        const status = document.querySelector(`#seen-${messageId}`);
        if (status) status.innerText = "‚úÖ Seen";
      });

      // Enhanced socket listeners
      socket.on('message-edited', (data) => {
        console.log('Message edited:', data);
        addToChat(`üìù Message edited: ${data.newMessage} (edited at ${new Date(data.editedAt).toLocaleTimeString()})`);
      });

      socket.on('message-deleted', (data) => {
        console.log('Message deleted:', data);
        addToChat(`üóëÔ∏è Message deleted (${data.deletedFor})`);
      });

      socket.on('reaction-added', (data) => {
        console.log('Reaction added:', data);
        addToChat(`${data.emoji} Reaction added to message`);
      });

      socket.on('search-results', (data) => {
        console.log('Search results:', data);
        addToChat(`üîç Found ${data.results.length} messages for "${data.query}"`);
        
        // Display search results
        if (data.results.length > 0) {
          data.results.forEach(result => {
            addToChat(`üìÑ Result: ${result.message} (${new Date(result.timestamp).toLocaleString()})`);
          });
        }
      });
    }

    function addToChat(message) {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML += `<div style="color: #666; font-style: italic;">${message}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
      const toUserId = document.getElementById('recipientId').value;
      const message = document.getElementById('messageInput').value;

      if (!socket || !socket.connected) {
        alert('You are not connected. Please enter JWT and click connect.');
        return;
      }

      if (!toUserId || !message) {
        alert('Please enter both recipient ID and message.');
        return;
      }

      const tempId = Date.now(); // Temporary ID to track the message
      socket.emit('private-message', { toUserId, message });

      const chatBox = document.getElementById('chatBox');
      const selfMsg = `
        <div style="text-align:right;">
          <b>You:</b> ${message}
          <div class="seen-status" id="seen-${tempId}">Sent</div>
        </div>
      `;
      chatBox.innerHTML += selfMsg;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById('messageInput').value = '';
    }

    function sendTyping() {
      const toUserId = document.getElementById('recipientId').value;
      if (socket && socket.connected && toUserId) {
        socket.emit('typing', { toUserId });
      }
    }

    // File upload functions
    async function uploadImage() {
      const input = document.getElementById('imageInput');
      const file = input.files[0];
      if (!file) return alert('Please select an image');

      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('/api/upload/image', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${document.getElementById('jwt').value}`
          },
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          console.log('Image uploaded:', result.image);
          // Send image message
          socket.emit('private-message', {
            toUserId: document.getElementById('recipientId').value,
            messageType: 'image',
            image: result.image
          });
          
          // Display in chat
          const chatBox = document.getElementById('chatBox');
          const selfMsg = `
            <div style="text-align:right;">
              <b>You:</b> <img src="${result.image.url}" alt="Image" style="max-width: 200px; max-height: 200px;" />
              <div class="seen-status">Sent</div>
            </div>
          `;
          chatBox.innerHTML += selfMsg;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (error) {
        console.error('Upload failed:', error);
        alert('Image upload failed');
      }
    }

    async function uploadFile() {
      const input = document.getElementById('fileInput');
      const file = input.files[0];
      if (!file) return alert('Please select a file');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/upload/file', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${document.getElementById('jwt').value}`
          },
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          console.log('File uploaded:', result.file);
          // Send file message
          socket.emit('private-message', {
            toUserId: document.getElementById('recipientId').value,
            messageType: 'file',
            file: result.file
          });
          
          // Display in chat
          const chatBox = document.getElementById('chatBox');
          const selfMsg = `
            <div style="text-align:right;">
              <b>You:</b> <a href="${result.file.url}" download="${result.file.originalName}">${result.file.originalName}</a>
              <div class="seen-status">Sent</div>
            </div>
          `;
          chatBox.innerHTML += selfMsg;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (error) {
        console.error('Upload failed:', error);
        alert('File upload failed');
      }
    }

    function editMessage() {
      const messageId = document.getElementById('messageIdInput').value;
      const newMessage = document.getElementById('editMessageInput').value;
      
      if (!messageId || !newMessage) return alert('Please provide message ID and new content');
      
      socket.emit('edit-message', { messageId, newMessage });
    }

    function deleteMessage(deleteFor) {
      const messageId = document.getElementById('messageIdInput').value;
      if (!messageId) return alert('Please provide message ID');
      
      socket.emit('delete-message', { messageId, deleteFor });
    }

    function addReaction(emoji) {
      const messageId = document.getElementById('messageIdInput').value;
      if (!messageId) return alert('Please provide message ID');
      
      socket.emit('add-reaction', { messageId, emoji });
    }

    function searchMessages() {
      const query = document.getElementById('searchInput').value;
      const userId = document.getElementById('recipientId').value;
      
      if (!query || !userId) return alert('Please provide search query and user ID');
      
      socket.emit('search-messages', { userId, query });
    }

    // Allow Enter key to send message
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      document.getElementById('editMessageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          editMessage();
        }
      });
      
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchMessages();
        }
      });
    });
  </script>
</body>
</html>